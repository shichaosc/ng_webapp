Signal_=function(a){function b(a,b,c){var d=new XMLHttpRequest,e=!1,f=setTimeout(function(){e=!0,d.abort(),c("timeout","")},b);d.open("GET",a),d.onreadystatechange=function(){4===d.readyState&&(e||(clearTimeout(f),200===d.status&&c("",d.responseText)))},d.send(null)}function d(a,b,c){var d=a.split(b,c),e=0;for(var f in d)e+=b.length+d[f].length;return d.push(a.substr(e)),d}this.vid=a,this.appid=a;var e=function(c,e){this.onLoginSuccess="",this.onLoginFailed="",this.onLogout="",this.onInviteReceived="",this.onMessageInstantReceive="",this.state="session_state_logining",this.line="",this.uid=0,this.dbg=!1;var g,f=this,h=function(){if(f.dbg){var a=[];for(var b in arguments)a.push(arguments[b]);console.log.apply(null,["Agora sig dbg :"].concat(a))}},i=[],j=function(){var a=i[Math.floor(Math.random()*i.length)],b=a[0].replace(/\./g,"-")+"-sig-web.agora.io",c=a[1]+1;return"wss://"+b+":"+c+"/"},k=function(c){b("//lbs-sig.agora.io/getaddr?vid="+a,5e3,function(a,b){a?c-1>0?k(c-1):fire_login_failed("lbs timeout"):(i=JSON.parse(b).web,l())})},l=function(){var b=j();g=new function(){var a=new WebSocket(b);a.onopen=function(b){h("on conn open");for(var c in e)a.send(JSON.stringify(e[c]))},a.onclose=function(a){d("_close",""),h("on conn close")},a.onmessage=function(a){var b=a.data,c=JSON.parse(b);c[0];d(c[0],c[1])},a.onerror=function(a){h("on conn error"),"session_state_logined"==f.state?t("conn error"):"session_state_logining"==f.state&&u("conn err")};var c={},d=function(a,b){a in c&&c[a](b)},e=[];this.on=function(a,b){c[a]=b},this.emit=function(b,c){return 0==a.readyState?void e.push([b,c]):void a.send(JSON.stringify([b,c]))},this.close=function(){a.close()}},f.socket=g;var i=0,k=function(){setTimeout(function(){"session_state_logined"==f.state&&(i++,h("send ping",i),g.emit("ping",i),k())},1e4)};""==f.line?(g.emit("login",{vid:a,account:c,uid:0,token:e,device:"websdk",ip:""}),g.on("login_ret",function(a){var b=a[0],c=JSON.parse(a[1]);h("login ret",b,c),b||"ok"!=c.result?f.onLoginFailed&&f.onLoginFailed(0):(f.uid=c.uid,f.line=c.line,f.state="session_state_logined",k(),F(),f.onLoginSuccess&&f.onLoginSuccess(f.uid),D())})):g.emit("line_login",{line:f.line});var l=0,m={},n={},o=function(a,b,c){l++,m[l]=[a,b,c],h("call ",[a,l,b]),g.emit("call2",[a,l,b])};g.on("call2-ret",function(a){var b=a[0],c=a[1],d=a[2];if(b in m){var e=m[b][2];e&&e(c,d)}});var q,p=function(a,b){return""==a},s=function(a){if(a.startsWith("msg-v2 ")){var b=d(a," ",6);if(7==b.length){var c=b[1],e=b[4],f=b[6];return[c,e,f]}}return null};g.on("pong",function(a){h("recv pong")}),g.on("close",function(a){t(0),g.close()}),g.on("_close",function(a){t(0)});var t=function(a){"session_state_logined"==f.state&&f.onLogout&&f.onLogout(0),f.state="session_state_logout"},u=function(a){"session_state_logining"==f.state&&f.onLoginFailed&&f.onLoginFailed(0),f.state="session_state_logout"},v=function(a){var b=a,c=b[0],d=b[1],e=b[2];if("instant"==d&&f.onMessageInstantReceive&&f.onMessageInstantReceive(c,0,e),d.startsWith("voip_")){var l,g=JSON.parse(e),h=g.channel,i=g.peer,j=g.extra,k=g.peeruid;if("voip_invite"==d)l=new G(h,i,k,j),o("voip_invite_ack",{line:f.line,channelName:h,peer:i,extra:""});else if(l=n[h+i],!l)return;"voip_invite"==d&&f.onInviteReceived&&f.onInviteReceived(l),"voip_invite_ack"==d&&l.onInviteReceivedByPeer&&l.onInviteReceivedByPeer(j),"voip_invite_accept"==d&&l.onInviteAcceptedByPeer&&l.onInviteAcceptedByPeer(j),"voip_invite_refuse"==d&&l.onInviteRefusedByPeer&&l.onInviteRefusedByPeer(j),"voip_invite_failed"==d&&l.onInviteFailed&&l.onInviteFailed(j),"voip_invite_bye"==d&&l.onInviteEndByPeer&&l.onInviteEndByPeer(j),"voip_invite_msg"==d&&l.onInviteMsg&&l.onInviteMsg(j)}},w=function(){return Date.now()},x=0,y=0,z=0,A=0,B=0,C=!1,D=function(){C||(C=!0,o("user_getmsg",{line:f.line,ver_clear:x,max:30},function(a,b){if(""==a){var c=JSON.parse(b);x=c.ver_clear,z=x;for(var e in c.msgs){var f=c.msgs[e][0],g=c.msgs[e][1];v(s(g)),x=f}(30==c.msgs.length||x<y)&&D(),A=w()}C=!1,B=w()}))},E=function(){B=w()},F=function(){setTimeout(function(){if("session_state_logout"!=f.state){if("session_state_logined"==f.state){var a=w();z<x&&a-B>1e3?D():a-B>=6e4&&D()}F()}},100)};g.on("notify",function(a){h("recv notify ",a),"string"==typeof a&&(a=d(a," ",2),a=a.slice(1));var b=a[0];if("channel2"==b){var c=a[1],e=a[2];if(0!=q.m_channel_msgid&&q.m_channel_msgid+1>e)return void h("ignore channel msg",c,e,q.m_channel_msgid);q.m_channel_msgid=e;var f=s(a[3]);if(f){var i=(f[0],f[1]),j=f[2],k=JSON.parse(j);"channel_msg"==i&&q.onMessageChannelReceive&&q.onMessageChannelReceive(k.account,k.uid,k.msg),"channel_user_join"==i&&q.onChannelUserJoined&&q.onChannelUserJoined(k.account,k.uid),"channel_user_leave"==i&&q.onChannelUserLeaved&&q.onChannelUserLeaved(k.account,k.uid),"channel_attr_update"==i&&q.onChannelAttrUpdated&&q.onChannelAttrUpdated(k.name,k.value,k.type)}}if("msg"==b&&(y=a[1],D()),"recvmsg"==b){var l=JSON.parse(a[1]),m=l[0],n=l[1];m==x+1?(v(s(n)),x=m,E()):(y=m,D())}}),f.logout=function(){o("user_logout",{line:f.line},function(a,b){t(a),g.close()})},f.messageInstantSend=function(a,b,c){o("user_sendmsg",{line:f.line,peer:a,flag:"v1:E:3600",t:"instant",content:b},function(a,b){c&&c(!p(a,b))})};var G=function(a,b,c){this.onInviteReceivedByPeer="",this.onInviteAcceptedByPeer="",this.onInviteRefusedByPeer="",this.onInviteFailed="",this.onInviteEndByPeer="",this.onInviteEndByMyself="",this.onInviteMsg="";var d=this;this.channelName=a,this.peer=b,this.extra=c,n[a+b]=d,this.channelInviteUser2=function(){c=c||"",o("voip_invite",{line:f.line,channelName:a,peer:b,extra:c},function(a,b){p(a,b)||d.onInviteFailed(a)})},this.channelInviteAccept=function(c){c=c||"",o("voip_invite_accept",{line:f.line,channelName:a,peer:b,extra:c})},this.channelInviteRefuse=function(c){c=c||"",o("voip_invite_refuse",{line:f.line,channelName:a,peer:b,extra:c})},this.channelInviteDTMF=function(c){o("voip_invite_msg",{line:f.line,channelName:a,peer:b,extra:JSON.stringify({msgtype:"dtmf",msgdata:c})})},this.channelInviteEnd=function(c){c=c||"",o("voip_invite_bye",{line:f.line,channelName:a,peer:b,extra:c}),d.onInviteEndByMyself&&d.onInviteEndByMyself("")}};f.channelInviteUser2=function(a,b,c){var d=new G(a,b,c);return d.channelInviteUser2(),d},f.channelJoin=function(a){return q=new function(){this.onChannelJoined="",this.onChannelJoinFailed="",this.onChannelLeaved="",this.onChannelUserList="",this.onChannelUserJoined="",this.onChannelUserLeaved="",this.onChannelUserList="",this.onChannelAttrUpdated="",this.onMessageChannelReceive="",this.name=a,this.state="joining",this.m_channel_msgid=0,this.messageChannelSend=function(b,c){o("channel_sendmsg",{line:f.line,name:a,msg:b},function(a,b){c&&c()})},this.channelLeave=function(b){o("channel_leave",{line:f.line,name:a},function(a,c){q.state="leaved",b?b():q.onChannelLeaved&&q.onChannelLeaved(0)})},this.channelSetAttr=function(b,c,d){o("channel_set_attr",{line:f.line,channel:a,name:b,value:c},function(a,b){d&&d()})},this.channelDelAttr=function(b,c){o("channel_del_attr",{line:f.line,channel:a,name:b},function(a,b){c&&c()})},this.channelClearAttr=function(b){o("channel_clear_attr",{line:f.line,channel:a},function(a,c){b&&b()})}},o("channel_join",{line:f.line,name:a},function(a,b){if(""==a){q.state="joined",q.onChannelJoined&&q.onChannelJoined();var c=JSON.parse(b);if(q.onChannelUserList&&q.onChannelUserList(c.list),q.onChannelAttrUpdated)for(var d in c.attrs)q.onChannelAttrUpdated("update",d,c.attrs[d])}else q.onChannelJoinFailed&&q.onChannelJoinFailed(a)}),q}};k(3)};this.login=function(a,b){return new e(a,b)}},Signal=function(a){return new Signal_(a)};
